generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================== ENUMS ==================

enum OrganizationRole {
  OWNER
  MEMBER
}

enum OrganizationMemberStatus {
  ACTIVE
  INVITED
  INACTIVE
}

enum ClientCrmStatus {
  LEAD        // потенційний
  IN_PROGRESS // в роботі
  ACTIVE      // постійний / активний
  INACTIVE    // неактивний
}

enum DocumentSource {
  UPLOAD
  MANUAL
  IMPORT
}

enum DocumentStatus {
  PROCESSING
  READY
  FAILED
}

enum ChatSessionStatus {
  ACTIVE
  ARCHIVED
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum TodoStatus {
  PENDING
  IN_PROGRESS
  DONE
  CANCELLED
}

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
}

enum PlanId {
  FREE
  BASIC
  PRO
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

// Інвойси

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// Акти

enum ActStatus {
  DRAFT
  SENT
  SIGNED
  CANCELLED
}

// ================== MODELS ==================

// ---- User ----

model User {
  id                  String    @id @default(cuid())
  authProvider        String
  authUserId          String    @unique
  email               String    @unique
  emailVerified       Boolean   @default(false)
  firstName           String?
  lastName            String?
  fullName            String?
  avatarUrl           String?
  locale              String?
  timezone            String?
  jobTitle            String?
  phone               String?
  onboardingCompleted Boolean   @default(false)
  lastLoginAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  subscription Subscription?

  organizations     UserOrganization[]
  ownedOrganization Organization?      @relation("OwnerOrganizations")

  documents    Document[]
  chatSessions ChatSession[]

  todoTasks      TodoTask[]
  todoDailyPlans TodoDailyPlan[]

  clients              Client[]
  invoices             Invoice[]
  acts                 Act[]
  quotes               Quote[]
  invoiceRemindersSent InvoiceReminderLog[] @relation("InvoiceReminderToUser")
  activityLogs         ActivityLog[]
  services UserService[]
}

// ---- Organization ----

model Organization {
  id                  String  @id @default(cuid())
  name                String
  slug                String  @unique
  logoUrl             String?
  industry            String?
  description         String?
  websiteUrl          String?
  country             String?
  city                String?
  timeZone            String?
  defaultLanguage     String?
  defaultCurrency     String?
  primaryContactName  String?
  primaryContactEmail String?
  primaryContactPhone String?

  businessNiche       String?
  servicesDescription String?
  targetAudience      String?
  brandStyle          String?

  // =========================
  // ✅ UA payment details (NEW)
  // =========================
  uaCompanyName          String? // Назва компанії/ФОП (UA)
  uaCompanyAddress       String? // Адреса (UA)
  uaEdrpou               String? // ЄДРПОУ
  uaIpn                  String? // ІПН (якщо треба)
  uaIban                 String?
  uaBankName             String?
  uaMfo                  String? // МФО (часто треба в UA реквізитах)
  uaAccountNumber        String? // якщо десь ще використовуєш не-IBAN
  uaBeneficiaryName      String? // Отримувач (UA)
  uaPaymentPurposeHint   String? // Призначення платежу (UA)

  // ==================================
  // ✅ International payment details
  // (RENAMED from your current fields)
  // ==================================
  intlLegalName            String?
  intlLegalAddress         String?
  intlVatId                String?
  intlRegistrationNumber   String?
  intlIban                 String?
  intlSwiftBic             String?
  intlBankName             String?
  intlBankAddress          String?
  intlBeneficiaryName      String?
  intlPaymentReferenceHint String?

  ownerId String @unique
  owner   User   @relation("OwnerOrganizations", fields: [ownerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members         UserOrganization[]
  businessProfile BusinessProfile?
  documents       Document[]
  chatSessions    ChatSession[]

  clients          Client[]
  invoices         Invoice[]
  acts             Act[]
  quotes           Quote[]
  invoiceReminders InvoiceReminderLog[] @relation("InvoiceReminderToOrg")
  activityLogs     ActivityLog[]
}


// ---- UserOrganization ----

model UserOrganization {
  id              String                   @id @default(cuid())
  userId          String
  organizationId  String
  invitedByUserId String?
  invitedAt       DateTime?
  joinedAt        DateTime?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  role            OrganizationRole         @default(MEMBER)
  status          OrganizationMemberStatus @default(ACTIVE)

  user         User         @relation(fields: [userId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@unique([userId, organizationId])
}

// ---- BusinessProfile ----

model BusinessProfile {
  id                    String   @id @default(cuid())
  organizationId        String   @unique
  tagline               String?
  niche                 String?
  longDescription       String?
  targetAudienceSummary String?
  targetMarkets         Json? // [{ country: "UA", segment: "SMB" }]
  businessModel         String? // "subscription", "services", etc.
  averageCheck          Int? // in defaultCurrency
  defaultPostLength     String? // "short" | "medium" | "long"
  preferredPlatforms    Json? // ["instagram", "email", "linkedin"]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
}

model Subscription {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  planId PlanId @default(FREE)
  pendingPlanId        PlanId?

  status             String   @default("active")
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean  @default(false)

  paddleCustomerId      String?
  paddleTransactionId   String? @unique
  paddleSubscriptionId  String? @unique
  paddleStatus          String?
  paddlePriceId         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ---- Documents ----

model Quote {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  createdById    String

  number     String
  issueDate  DateTime  @default(now())
  validUntil DateTime?

  currency String      @default("USD")
  status   QuoteStatus @default(DRAFT)

  subtotal  Decimal  @db.Decimal(18, 2)
  taxAmount Decimal? @db.Decimal(18, 2)
  total     Decimal  @db.Decimal(18, 2)

  notes String?

  sentAt DateTime?

  lastEmailedTo  String?
  emailMessageId String?

  convertedInvoiceId String?  @unique
  convertedInvoice   Invoice? @relation(fields: [convertedInvoiceId], references: [id])

  organization Organization @relation(fields: [organizationId], references: [id])
  client       Client?      @relation(fields: [clientId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  items QuoteItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  pdfDocumentId String?   @unique
  pdfDocument   Document? @relation("QuoteDocument", fields: [pdfDocumentId], references: [id])

  @@unique([organizationId, number])
  @@index([organizationId, createdAt])
}

model QuoteItem {
  id      String @id @default(cuid())
  quoteId String

  name        String
  description String?
  quantity    Int
  unitPrice   Decimal  @db.Decimal(18, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  lineTotal   Decimal  @db.Decimal(18, 2)

  quote Quote @relation(fields: [quoteId], references: [id])

  @@index([quoteId])
}

model Document {
  id             String @id @default(cuid())
  organizationId String
  createdById    String

  title        String
  originalName String
  mimeType     String
  sizeBytes    Int

  storageKey String
  source     DocumentSource @default(UPLOAD)
  status     DocumentStatus @default(PROCESSING)

  description String?
  language    String?
  tags        String[] @default([])

  pages      Int?
  chunkCount Int  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id])
  createdBy    User            @relation(fields: [createdById], references: [id])
  chunks       DocumentChunk[]

  // pdf-документ для інвойсу
  invoice Invoice? @relation("InvoiceDocument")

  // ✅ pdf-документ для інвойсу (International)
  invoiceInternational Invoice? @relation("InvoiceInternationalDocument")

  // pdf-документ для акта
  act   Act?   @relation("ActDocument")
  quote Quote? @relation("QuoteDocument")
}

model DocumentChunk {
  id         String @id @default(cuid())
  documentId String

  chunkIndex Int
  content    String
  tokenCount Int?

  embedding Float[] @default([])

  createdAt DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id])

  @@index([documentId])
  @@index([chunkIndex])
}

// ---- Chat ----

model ChatSession {
  id             String       @id @default(cuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  title  String
  status ChatSessionStatus @default(ACTIVE)

  allowKnowledgeBase Boolean @default(true)

  messages ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatMessage {
  id String @id @default(cuid())

  session   ChatSession @relation(fields: [sessionId], references: [id])
  sessionId String

  role     ChatMessageRole
  content  String
  metadata Json?

  createdAt DateTime @default(now())
}

// ---- Clients ----

model Client {
  id             String  @id @default(cuid())
  organizationId String
  createdById    String? // <-- робимо опціональним

  name        String
  contactName String?
  email       String?
  phone       String?
  address     String?
  taxNumber   String?
  notes       String?

  crmStatus ClientCrmStatus @default(LEAD)
  tags      String[]        @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User?        @relation(fields: [createdById], references: [id])

  invoices Invoice[]
  acts     Act[]
  quotes   Quote[]
}


// ---- Invoices ----

model Invoice {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String? // може бути null, якщо інвойс без клієнта
  createdById    String

  number    String
  issueDate DateTime
  dueDate   DateTime?

  currency String        @default("UAH")
  status   InvoiceStatus @default(DRAFT)

  subtotal  Decimal  @db.Decimal(18, 2)
  taxAmount Decimal? @db.Decimal(18, 2)
  total     Decimal  @db.Decimal(18, 2)

  notes  String?
  sentAt DateTime?
  paidAt DateTime?

  // UA PDF
  pdfDocumentId String?   @unique
  pdfDocument   Document? @relation("InvoiceDocument", fields: [pdfDocumentId], references: [id])

  // ✅ International PDF (окремий документ, щоб не перетирав UA)
  pdfInternationalDocumentId String?   @unique
  pdfInternationalDocument   Document? @relation("InvoiceInternationalDocument", fields: [pdfInternationalDocumentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  client       Client?      @relation(fields: [clientId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  items              InvoiceItem[]
  acts               Act[]
  convertedFromQuote Quote?
  reminders          InvoiceReminderLog[] @relation("InvoiceReminderToInvoice")

  @@unique([organizationId, number])
  @@index([organizationId, createdAt])
}

model InvoiceItem {
  id        String @id @default(cuid())
  invoiceId String

  name        String
  description String?
  quantity    Int
  unitPrice   Decimal  @db.Decimal(18, 2)
  taxRate     Decimal? @db.Decimal(5, 2) // у відсотках
  lineTotal   Decimal  @db.Decimal(18, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
}

// ---- Acts ----

model Act {
  id             String @id @default(cuid())
  organizationId String
  clientId       String
  createdById    String

  number     String
  title      String?
  periodFrom DateTime?
  periodTo   DateTime?

  total    Decimal @db.Decimal(18, 2)
  currency String  @default("UAH")

  status ActStatus @default(DRAFT)
  notes  String?

  relatedInvoiceId String?
  relatedInvoice   Invoice? @relation(fields: [relatedInvoiceId], references: [id])

  pdfDocumentId String?   @unique
  pdfDocument   Document? @relation("ActDocument", fields: [pdfDocumentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  client       Client       @relation(fields: [clientId], references: [id])
  createdBy    User         @relation(fields: [createdById], references: [id])

  @@unique([organizationId, number])
  @@index([organizationId, createdAt])
  @@index([relatedInvoiceId])
}

// ===== TODO календар =====

model TodoTask {
  id             String  @id @default(cuid())
  userId         String
  organizationId String? // просто String, без реляції в Organization

  title       String
  description String?

  startAt DateTime
  endAt   DateTime?

  status   TodoStatus   @default(PENDING)
  priority TodoPriority @default(MEDIUM)

  isPinned Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, startAt])
  @@index([organizationId, startAt])
}

model TodoDailyPlan {
  id     String @id @default(cuid())
  userId String
  date   String

  summary     String
  suggestions Json
  timeline    Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

enum InvoiceReminderKind {
  DEADLINE
}

model InvoiceReminderLog {
  id             String @id @default(cuid())
  invoiceId      String
  organizationId String
  sentById       String

  kind InvoiceReminderKind @default(DEADLINE)

  toEmail String
  subject String?
  message String?
  sentAt  DateTime @default(now())

  invoice      Invoice      @relation("InvoiceReminderToInvoice", fields: [invoiceId], references: [id])
  organization Organization @relation("InvoiceReminderToOrg", fields: [organizationId], references: [id])
  sentBy       User         @relation("InvoiceReminderToUser", fields: [sentById], references: [id])

  @@index([organizationId, sentAt])
  @@index([invoiceId, sentAt])
  @@index([invoiceId, kind, sentAt])
}

enum ActivityEntityType {
  INVOICE
  ACT
  QUOTE
}

enum ActivityEventType {
  CREATED
  STATUS_CHANGED
  SENT
  REMINDER_SENT
}

model ActivityLog {
  id             String @id @default(cuid())
  organizationId String
  actorUserId    String

  entityType ActivityEntityType
  entityId   String

  eventType ActivityEventType

  // для статусів (SENT/PAID/CANCELLED/etc)
  fromStatus String?
  toStatus   String?

  // для email подій
  toEmail String?

  // додаткові поля на майбутнє (номер документа, сума, будь-що)
  meta Json?

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  actor        User         @relation(fields: [actorUserId], references: [id])

  @@index([organizationId, createdAt])
  @@index([organizationId, entityType, createdAt])
  @@index([organizationId, entityType, entityId, createdAt])
}

model UserService {
  id          String   @id @default(cuid())
  userId      String

  name        String
  description String?
  price       Decimal  @db.Decimal(18, 2)

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isActive])
  @@index([userId, createdAt])
}